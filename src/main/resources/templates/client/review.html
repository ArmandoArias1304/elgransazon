<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Sazón - Mi Reseña</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: "#38e07b",
                dark: "#2bc866",
              },
            },
          },
        },
      };
    </script>
    <style>
      .star-rating {
        display: inline-flex;
        gap: 0.5rem;
        font-size: 2.5rem;
      }
      .star {
        cursor: pointer;
        color: #d1d5db;
        transition: all 0.2s ease;
      }
      .dark .star {
        color: #4b5563;
      }
      .star:hover,
      .star.active {
        color: #fbbf24;
        transform: scale(1.1);
      }
      .star.half {
        color: #fbbf24;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 font-display min-h-screen"
  >
    <!-- NAVIGATION BAR -->
    <nav class="bg-gradient-to-r from-primary to-primary-dark shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16 sm:h-20">
          <!-- Logo -->
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full flex items-center justify-center shadow-lg"
            >
              <span
                class="material-symbols-outlined text-primary text-xl sm:text-2xl"
                >restaurant</span
              >
            </div>
            <div>
              <h1 class="text-white font-bold text-lg sm:text-xl">
                El Gran Sazón
              </h1>
              <p class="text-white/80 text-xs sm:text-sm">Mi Reseña</p>
            </div>
          </div>

          <!-- Back Button -->
          <a
            href="/client/dashboard"
            class="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl transition-all"
          >
            <span class="material-symbols-outlined">arrow_back</span>
            <span class="hidden sm:inline">Volver</span>
          </a>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
      <!-- Error Message -->
      <div
        th:if="${errorMessage}"
        class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl text-red-800 dark:text-red-300 flex items-center gap-3"
      >
        <span class="material-symbols-outlined">error</span>
        <span th:text="${errorMessage}">Error message</span>
      </div>

      <!-- Success Message -->
      <div
        th:if="${successMessage}"
        class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border-2 border-green-200 dark:border-green-800 rounded-xl text-green-800 dark:text-green-300 flex items-center gap-3"
      >
        <span class="material-symbols-outlined">check_circle</span>
        <span th:text="${successMessage}">Success message</span>
      </div>

      <!-- No Purchase Warning -->
      <div
        th:if="${noPurchase}"
        class="bg-white dark:bg-gray-900 rounded-3xl shadow-xl p-8 sm:p-12 border border-gray-200 dark:border-gray-800"
      >
        <div class="text-center">
          <div
            class="w-24 h-24 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl"
          >
            <span class="material-symbols-outlined text-white text-5xl"
              >shopping_cart</span
            >
          </div>
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
            ¡Realiza tu primera compra!
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-8 text-lg">
            Para dejar una reseña, primero necesitas realizar al menos una
            compra en nuestro restaurante. ¡Descubre nuestro delicioso menú!
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="/client/menu"
              class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold rounded-xl hover:shadow-xl hover:scale-105 transition-all"
            >
              <span class="material-symbols-outlined">restaurant_menu</span>
              Ver Menú
            </a>
            <a
              href="/client/dashboard"
              class="inline-flex items-center justify-center gap-2 px-8 py-4 border-2 border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all"
            >
              <span class="material-symbols-outlined">home</span>
              Volver al Inicio
            </a>
          </div>
        </div>
      </div>

      <!-- Review Form Card -->
      <div
        th:unless="${noPurchase}"
        <div
        class="bg-white dark:bg-gray-900 rounded-3xl shadow-xl p-8 sm:p-12 border border-gray-200 dark:border-gray-800"
      >
        <!-- Header -->
        <div class="text-center mb-8">
          <div
            class="w-20 h-20 bg-gradient-to-br from-primary to-primary-dark rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl"
          >
            <span class="material-symbols-outlined text-white text-4xl"
              >rate_review</span
            >
          </div>
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            <span th:if="${hasReview}">Editar mi Reseña</span>
            <span th:unless="${hasReview}">Dejar una Reseña</span>
          </h2>
          <p class="text-gray-600 dark:text-gray-400">
            <span th:if="${hasReview}"
              >Actualiza tu opinión sobre nuestro servicio</span
            >
            <span th:unless="${hasReview}"
              >Comparte tu experiencia con nosotros</span
            >
          </p>
        </div>

        <!-- Generic Review Status (if exists) -->
        <div
          th:if="${existingReview}"
          class="mb-6 p-4 rounded-xl border-2 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800"
        >
          <div class="flex items-center gap-3">
            <span
              class="material-symbols-outlined text-blue-600 dark:text-blue-400"
            >
              info
            </span>
            <div>
              <p class="font-semibold text-blue-800 dark:text-blue-300">
                Su reseña se ha enviado correctamente
              </p>
              <p class="text-sm text-blue-600 dark:text-blue-400">
                ¡Gracias por compartir su opinión con nosotros!
              </p>
            </div>
          </div>
        </div>

        <!-- Review Form -->
        <form method="POST" action="/client/review" class="space-y-6">
          <!-- Rating -->
          <div>
            <label
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-3 text-lg"
            >
              Calificación <span class="text-red-500">*</span>
            </label>
            <div class="flex justify-center">
              <div class="star-rating">
                <span class="star" data-rating="1">★</span>
                <span class="star" data-rating="2">★</span>
                <span class="star" data-rating="3">★</span>
                <span class="star" data-rating="4">★</span>
                <span class="star" data-rating="5">★</span>
              </div>
            </div>
            <input
              type="hidden"
              name="rating"
              id="ratingInput"
              th:value="${existingReview != null ? existingReview.rating : 0}"
              required
            />
            <p
              class="text-center text-gray-500 dark:text-gray-400 text-sm mt-2"
            >
              Haz clic en las estrellas para calificar
            </p>
          </div>

          <!-- Comment -->
          <div>
            <label
              for="comment"
              class="block text-gray-700 dark:text-gray-300 font-semibold mb-2"
            >
              Tu Comentario <span class="text-red-500">*</span>
            </label>
            <textarea
              id="comment"
              name="comment"
              rows="5"
              maxlength="500"
              required
              minlength="10"
              class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all resize-none"
              placeholder="Cuéntanos sobre tu experiencia... (mínimo 10 caracteres)"
              th:text="${existingReview != null ? existingReview.comment : ''}"
            ></textarea>
            <div
              class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1"
            >
              <span>Mínimo 10 caracteres</span>
              <span id="charCount">0 / 500</span>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="flex gap-4">
            <button
              type="submit"
              class="flex-1 bg-gradient-to-r from-primary to-primary-dark text-white font-bold py-4 px-6 rounded-xl hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined">send</span>
              <span th:if="${hasReview}">Actualizar Reseña</span>
              <span th:unless="${hasReview}">Enviar Reseña</span>
            </button>
            <a
              href="/client/dashboard"
              class="px-6 py-4 border-2 border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined">close</span>
              <span class="hidden sm:inline">Cancelar</span>
            </a>
          </div>
        </form>
      </div>
      <!-- End Review Form Card -->
    </div>

    <script>
      // Star rating functionality
      const stars = document.querySelectorAll(".star");
      const ratingInput = document.getElementById("ratingInput");
      let currentRating = parseInt(ratingInput.value) || 0;

      // Initialize stars based on existing rating
      function updateStars(rating) {
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });
      }

      // Set initial rating
      updateStars(currentRating);

      stars.forEach((star) => {
        star.addEventListener("click", function () {
          const rating = parseInt(this.dataset.rating);
          currentRating = rating;
          ratingInput.value = rating;
          updateStars(rating);
        });

        star.addEventListener("mouseenter", function () {
          const rating = parseInt(this.dataset.rating);
          updateStars(rating);
        });
      });

      document
        .querySelector(".star-rating")
        .addEventListener("mouseleave", function () {
          updateStars(currentRating);
        });

      // Character counter
      const textarea = document.getElementById("comment");
      const charCount = document.getElementById("charCount");

      function updateCharCount() {
        const length = textarea.value.length;
        charCount.textContent = `${length} / 500`;

        if (length < 10) {
          charCount.classList.add("text-red-500");
          charCount.classList.remove("text-gray-500");
        } else {
          charCount.classList.remove("text-red-500");
          charCount.classList.add("text-gray-500");
        }
      }

      textarea.addEventListener("input", updateCharCount);

      // Initial count
      updateCharCount();

      // Form validation
      document.querySelector("form").addEventListener("submit", function (e) {
        if (currentRating === 0) {
          e.preventDefault();
          Swal.fire({
            icon: "warning",
            title: "Calificación requerida",
            text: "Por favor selecciona una calificación con las estrellas",
            confirmButtonText: "Entendido",
            confirmButtonColor: "#38e07b",
          });
          return false;
        }

        if (textarea.value.trim().length < 10) {
          e.preventDefault();
          Swal.fire({
            icon: "warning",
            title: "Comentario muy corto",
            text: "El comentario debe tener al menos 10 caracteres",
            confirmButtonText: "Entendido",
            confirmButtonColor: "#38e07b",
          });
          return false;
        }
      });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
