<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="'El Gran Saz√≥n - Pedidos Pendientes (' + ${role} + ')'">
      El Gran Saz√≥n - Pedidos Pendientes
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8faf9",
            },
            fontFamily: {
              display: ["Work Sans"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              "2xl": "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }

      body {
        font-family: "Work Sans", sans-serif;
      }

      /* Efecto de pedido pendiente - overlay azul */
      .card.pending::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(205, 241, 254, 0.4);
        z-index: 1;
        pointer-events: none;
      }

      .card.pending .card-body {
        opacity: 1;
        filter: brightness(1.6);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-gray-900 dark:to-gray-800 font-display text-gray-800 dark:text-gray-100"
  >
    <div class="flex flex-col min-h-screen">
      <!-- Header -->
      <header
        class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-lg sticky top-0 z-30"
      >
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
          >
            <div class="flex items-center gap-3 sm:gap-4">
              <div
                class="w-12 h-12 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/30"
              >
                <span class="material-symbols-outlined text-white text-2xl"
                  >restaurant</span
                >
              </div>
              <div>
                <h1
                  class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white"
                >
                  <span th:if="${isBarista}">‚òï Gesti√≥n de Pedidos</span>
                  <span th:unless="${isBarista}">üë®‚Äçüç≥ Gesti√≥n de Pedidos</span>
                </h1>
                <p class="text-sm text-gray-600 dark:text-gray-300">
                  <span th:if="${isBarista}"
                    >Todos los pedidos activos de barra</span
                  >
                  <span th:unless="${isBarista}"
                    >Todos los pedidos activos de cocina</span
                  >
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <a
                th:href="@{/chef/orders/my-orders}"
                class="flex items-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-xl bg-blue-600 hover:bg-blue-700 text-white hover:shadow-lg hover:shadow-blue-500/30 transition-all"
              >
                <span class="material-symbols-outlined">history</span>
                <span class="hidden sm:inline">Ver Historial</span>
              </a>
              <a
                th:href="@{/chef/dashboard}"
                class="flex items-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white hover:shadow-lg hover:shadow-primary/30 transition-all"
              >
                <span class="material-symbols-outlined">dashboard</span>
                <span class="hidden sm:inline">Dashboard</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main
        class="flex-1 w-full max-w-screen-2xl px-4 py-6 mx-auto sm:px-6 lg:px-8 pb-32"
      >
        <!-- Statistics -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <!-- Pending Count -->
          <div
            class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg p-6 hover:shadow-xl transition-shadow"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p
                  class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1"
                >
                  Pendientes
                </p>
                <p
                  class="text-3xl font-bold text-orange-600 dark:text-orange-400"
                  th:text="${pendingCount}"
                >
                  0
                </p>
              </div>
              <div
                class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/30"
              >
                <span class="material-symbols-outlined text-white text-3xl"
                  >pending_actions</span
                >
              </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Sin iniciar preparaci√≥n
            </p>
          </div>

          <!-- In Preparation Count -->
          <div
            class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg p-6 hover:shadow-xl transition-shadow"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p
                  class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1"
                >
                  En Preparaci√≥n
                </p>
                <p
                  class="text-3xl font-bold text-blue-600 dark:text-blue-400"
                  th:text="${inPreparationCount}"
                >
                  0
                </p>
              </div>
              <div
                class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30"
              >
                <span class="material-symbols-outlined text-white text-3xl"
                  >restaurant</span
                >
              </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              <span th:if="${isBarista}">Pedidos en barra</span>
              <span th:unless="${isBarista}">Pedidos en cocina</span>
            </p>
          </div>
        </div>

        <!-- Empty State -->
        <div
          th:if="${orders.isEmpty()}"
          class="flex flex-col items-center justify-center py-16 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700"
        >
          <div
            class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 rounded-2xl flex items-center justify-center mb-6"
          >
            <span
              class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-300"
            >
              check_circle
            </span>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
            ¬°Excelente! No hay pedidos activos
          </h3>
          <p class="text-gray-600 dark:text-gray-300">
            Todos los pedidos han sido procesados
          </p>
        </div>

        <!-- Orders Grid -->
        <div
          th:if="${!orders.isEmpty()}"
          class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4"
          id="ordersGrid"
        >
          <!-- ORDER CARD -->
          <div
            th:each="order : ${orders}"
            th:attr="data-order-id=${order.idOrder}"
            class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-3xl shadow-md hover:shadow-2xl flex flex-col overflow-hidden transition-all duration-300 h-[490px]"
            th:classappend="${order.status.name() == 'PENDING'} ? 'relative' : ''"
          >
            <!-- Overlay azul para pedidos pendientes -->
            <div
              th:if="${order.status.name() == 'PENDING'}"
              class="absolute inset-0 bg-cyan-100/40 dark:bg-cyan-900/20 z-[1] pointer-events-none"
            ></div>

            <!-- Card Header -->
            <div
              class="px-6 py-5 flex justify-between items-center border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex-shrink-0 relative z-[2]"
            >
              <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  <span
                    th:if="${order.table != null}"
                    th:text="'Mesa ' + ${order.table.tableNumber}"
                  ></span>
                  <span
                    th:if="${order.table == null && order.orderType.name() == 'TAKEOUT'}"
                  >
                    Para llevar
                  </span>
                  <span
                    th:if="${order.table == null && order.orderType.name() == 'DELIVERY'}"
                  >
                    Delivery
                  </span>
                  <span
                    th:if="${order.table == null && order.customerName != null && order.orderType.name() == 'DINE_IN'}"
                    th:text="${order.customerName}"
                  ></span>
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">
                  Creado por: <span th:text="${order.createdBy}"></span>
                </p>
                <p
                  class="text-xs text-gray-500 dark:text-gray-400 font-semibold mt-0.5"
                >
                  Pedido <span th:text="${order.orderNumber}"></span>
                </p>
              </div>
              <div class="flex flex-col items-end gap-2">
                <!-- Order Type Badge -->
                <span
                  th:if="${order.orderType.name() == 'DINE_IN'}"
                  class="px-4 py-2 rounded-full text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300"
                >
                  üçΩÔ∏è Mesa
                </span>
                <span
                  th:if="${order.orderType.name() == 'TAKEOUT'}"
                  class="px-4 py-2 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300"
                >
                  üì¶ Llevar
                </span>
                <span
                  th:if="${order.orderType.name() == 'DELIVERY'}"
                  class="px-4 py-2 rounded-full text-xs font-semibold bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300"
                >
                  üöó Delivery
                </span>

                <!-- Status Badge -->
                <span
                  th:if="${order.status.name() == 'PENDING'}"
                  class="px-4 py-2 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300"
                >
                  ‚è≥ Pendiente
                </span>
                <span
                  th:if="${order.status.name() == 'IN_PREPARATION'}"
                  class="px-4 py-2 rounded-full text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300"
                >
                  üë®‚Äçüç≥ Preparando
                </span>
              </div>
            </div>

            <!-- Card Body - Order Details -->
            <div
              class="p-5 flex-1 overflow-y-auto overflow-x-hidden relative z-[2]"
              th:classappend="${order.status.name() == 'PENDING'} ? 'brightness-150' : ''"
            >
              <h4
                class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 uppercase tracking-wide"
              >
                Detalles del Pedido:
              </h4>
              <div class="space-y-1">
                <!-- FILTER: Chef sees items with requiresPreparation, Barista sees items with requiresBaristaPreparation -->
                <div
                  th:each="detail : ${order.orderDetails}"
                  th:if="${isBarista ? (detail.itemMenu.requiresBaristaPreparation == true) : (detail.itemMenu.requiresPreparation == true)}"
                  class="py-4 border-b border-gray-100 dark:border-gray-700 flex flex-col gap-2 last:border-b-0"
                >
                  <div class="flex items-start justify-between w-full gap-2">
                    <div class="flex-1">
                      <p
                        class="text-base font-semibold text-gray-900 dark:text-white"
                      >
                        <span th:text="${detail.quantity} + 'x'"></span>
                        <span th:text="${detail.itemMenu.name}"></span>
                      </p>

                      <!-- NEW ITEM Badge - Improved Design -->
                      <!-- Only show for new items that are NOT yet READY or DELIVERED -->
                      <div
                        th:if="${detail.isNewItem != null && detail.isNewItem && detail.itemStatus.name() != 'READY' && detail.itemStatus.name() != 'DELIVERED'}"
                        class="mt-2"
                      >
                        <span
                          class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg shadow-red-500/50 animate-pulse border border-red-300"
                        >
                          <span
                            class="material-symbols-outlined !text-sm font-bold"
                          >
                            notification_important
                          </span>
                          ¬°NUEVO ITEM!
                        </span>
                        <p
                          class="text-xs text-gray-500 dark:text-gray-400 mt-1.5 ml-1"
                        >
                          üïê
                          <span
                            th:text="${#temporals.format(detail.addedAt, 'HH:mm')}"
                          ></span>
                        </p>
                      </div>

                      <!-- Item Status Badge -->
                      <div class="mt-1.5">
                        <span
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'PENDING'}"
                          class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >schedule</span
                          >
                          Pendiente
                        </span>
                        <span
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'IN_PREPARATION'}"
                          class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >cooking</span
                          >
                          Preparando
                        </span>
                        <span
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'READY'}"
                          class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >check_circle</span
                          >
                          Listo
                        </span>
                        <span
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'DELIVERED'}"
                          class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300"
                        >
                          <span class="material-symbols-outlined !text-xs"
                            >done_all</span
                          >
                          Entregado
                        </span>
                      </div>

                      <!-- CHEF: No item-level buttons - uses order-level bulk button only -->

                      <!-- Barista Item Control Buttons -->
                      <div th:if="${isBarista}" class="mt-3 flex gap-2">
                        <!-- Accept Item Button (PENDING -> IN_PREPARATION) -->
                        <button
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'PENDING'}"
                          th:attr="data-order-id=${order.idOrder}, data-item-id=${detail.idOrderDetail}, data-item-name=${detail.itemMenu.name}"
                          class="btn-accept-item flex-1 px-3 py-2 text-xs font-bold text-white bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                        >
                          <span class="material-symbols-outlined !text-sm"
                            >play_arrow</span
                          >
                          Comenzar
                        </button>

                        <!-- Mark Item as Ready Button (IN_PREPARATION -> READY) -->
                        <button
                          th:if="${detail.itemStatus != null && detail.itemStatus.name() == 'IN_PREPARATION'}"
                          th:attr="data-order-id=${order.idOrder}, data-item-id=${detail.idOrderDetail}, data-item-name=${detail.itemMenu.name}"
                          class="btn-ready-item flex-1 px-3 py-2 text-xs font-bold text-white bg-gradient-to-br from-primary to-primary-dark rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                        >
                          <span class="material-symbols-outlined !text-sm"
                            >check_circle</span
                          >
                          Marcar Listo
                        </button>
                      </div>

                      <!-- Added At (for new items) -->
                    </div>
                  </div>
                  <p
                    th:if="${detail.comments != null && !detail.comments.isEmpty()}"
                    class="text-sm text-gray-600 dark:text-gray-300 pl-4"
                  >
                    üí¨ <span th:text="${detail.comments}"></span>
                  </p>
                </div>
              </div>
            </div>

            <!-- Card Footer -->
            <div
              class="p-5 bg-gray-50 dark:bg-gray-900 flex flex-col gap-3 border-t border-gray-100 dark:border-gray-700 flex-shrink-0 relative z-[2]"
            >
              <!-- Server Info -->
              <div
                class="text-xs text-gray-600 dark:text-gray-300 pb-2 border-b border-gray-200 dark:border-gray-600"
              >
                <span class="font-medium">Levantado por:</span>
                <span
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${order.createdBy}"
                ></span>
                <br />
                <span class="font-medium">Creado:</span>
                <span
                  class="font-semibold text-gray-900 dark:text-white"
                  th:text="${#temporals.format(order.createdAt, 'HH:mm')}"
                ></span>
              </div>

              <!-- Action Buttons -->
              <!-- CHEF: Show order-level buttons that change ALL chef items -->
              <div th:if="${!isBarista}">
                <!-- PRIORITY 1: If ANY item is IN_PREPARATION, show ONLY "Marcar Listo" button -->
                <!-- This button will move ALL chef items (including PENDING ones) to READY -->
                <button
                  th:if="${#lists.size(order.orderDetails.?[itemMenu.requiresPreparation == true && itemStatus.name() == 'IN_PREPARATION']) > 0}"
                  th:attr="data-order-id=${order.idOrder}, data-order-number=${order.orderNumber}"
                  class="btn-mark-all-ready flex-1 px-6 py-3.5 text-base font-bold text-center text-white bg-gradient-to-br from-primary to-primary-dark rounded-xl transition-all duration-300 flex items-center justify-center gap-2 border-0 cursor-pointer shadow-lg shadow-primary/40 hover:-translate-y-0.5"
                >
                  <span class="material-symbols-outlined !text-base"
                    >check_circle</span
                  >
                  Marcar Todo Listo
                </button>

                <!-- PRIORITY 2: If NO items are IN_PREPARATION but there are PENDING items, show "Comenzar" button -->
                <button
                  th:if="${#lists.size(order.orderDetails.?[itemMenu.requiresPreparation == true && itemStatus.name() == 'IN_PREPARATION']) == 0 && #lists.size(order.orderDetails.?[itemMenu.requiresPreparation == true && itemStatus.name() == 'PENDING']) > 0}"
                  th:attr="data-order-id=${order.idOrder}, data-order-number=${order.orderNumber}"
                  class="btn-accept-all-chef-items flex-1 px-6 py-3.5 text-base font-bold text-center text-white bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl transition-all duration-300 flex items-center justify-center gap-2 border-0 cursor-pointer shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:-translate-y-0.5 relative z-[2]"
                >
                  <span
                    class="material-symbols-outlined !text-base animate-pulse"
                    >restaurant</span
                  >
                  Comenzar Preparaci√≥n
                </button>

                <p
                  class="text-xs text-gray-500 dark:text-gray-400 text-center mt-2"
                >
                  Este bot√≥n cambia el estado de todos tus items
                </p>
              </div>

              <!-- BARISTA: Show item-level instructions -->
              <div th:if="${isBarista}" class="text-center py-3">
                <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">
                  ‚òï Usa los botones en cada item para controlar su preparaci√≥n
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                  El estado de la orden se actualiza autom√°ticamente cuando
                  cambias los items
                </p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const currentRole = /*[[${isBarista ? 'barista' : 'chef'}]]*/ "chef";
      /*]]>*/

      // CHEF: Accept ALL chef items in order (PENDING -> IN_PREPARATION)
      function acceptAllChefItems(orderId, orderNumber) {
        Swal.fire({
          title: "¬øComenzar preparaci√≥n?",
          text: `¬øDeseas comenzar a preparar todos los items del pedido ${orderNumber}?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "S√≠, comenzar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#3b82f6",
          cancelButtonColor: "#6b7280",
        }).then((result) => {
          if (result.isConfirmed) {
            changeAllChefItems(
              orderId,
              orderNumber,
              "Comenzando preparaci√≥n...",
              "Preparaci√≥n Iniciada",
              "Todos los items del chef est√°n ahora en preparaci√≥n"
            );
          }
        });
      }

      // CHEF: Mark ALL chef items as READY (IN_PREPARATION -> READY)
      function markAllChefItemsReady(orderId, orderNumber) {
        Swal.fire({
          title: "¬øMarcar todo listo?",
          text: `¬øTodos los items del pedido ${orderNumber} est√°n listos?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "S√≠, todo listo",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#6b7280",
        }).then((result) => {
          if (result.isConfirmed) {
            changeAllChefItems(
              orderId,
              orderNumber,
              "Marcando items como listos...",
              "Items Listos",
              "Todos los items del chef est√°n listos para servir"
            );
          }
        });
      }

      // Generic function to change ALL chef items
      function changeAllChefItems(
        orderId,
        orderNumber,
        loadingText,
        successTitle,
        successText
      ) {
        Swal.fire({
          title: loadingText,
          text: "Por favor espere",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            Swal.showLoading();

            fetch(`/${currentRole}/orders/${orderId}/change-all-chef-items`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                Swal.close();

                if (data.success) {
                  Swal.fire({
                    icon: "success",
                    title: successTitle,
                    text: `${successText}: ${orderNumber}`,
                    timer: 1500,
                    showConfirmButton: false,
                  }).then(() => {
                    // Reload to update the view
                    window.location.reload();
                  });
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message || "No se pudo cambiar el estado",
                  });
                }
              })
              .catch((error) => {
                Swal.close();
                console.error("Error:", error);
                Swal.fire({
                  icon: "error",
                  title: "Error",
                  text: "Error al cambiar el estado de los items",
                });
              });
          },
        });
      }

      // Barista: Accept individual item (PENDING -> IN_PREPARATION)
      function acceptItem(orderId, itemId, itemName) {
        Swal.fire({
          title: "¬øMarcar como listo?",
          text: `¬øEl pedido ${orderNumber} est√° listo para servir?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "S√≠, est√° listo",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#10b981",
          cancelButtonColor: "#6b7280",
        }).then((result) => {
          if (result.isConfirmed) {
            changeOrderStatus(
              orderId,
              orderNumber,
              "READY",
              "Marcando como listo...",
              "Pedido Listo",
              "El pedido est√° listo para servir"
            );
          }
        });
      }

      // Generic function to change order status
      function changeOrderStatus(
        orderId,
        orderNumber,
        newStatus,
        loadingText,
        successTitle,
        successText
      ) {
        Swal.fire({
          title: loadingText,
          text: "Por favor espere",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            Swal.showLoading();

            fetch(`/${currentRole}/orders/${orderId}/change-status`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `newStatus=${newStatus}`,
            })
              .then((response) => response.json())
              .then((data) => {
                Swal.close();

                if (data.success) {
                  Swal.fire({
                    icon: "success",
                    title: successTitle,
                    text: `${successText}: ${orderNumber}`,
                    timer: 1500,
                    showConfirmButton: false,
                  }).then(() => {
                    // Reload to update the view
                    window.location.reload();
                  });
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message || "No se pudo cambiar el estado",
                  });
                }
              })
              .catch((error) => {
                Swal.close();
                console.error("Error:", error);
                Swal.fire({
                  icon: "error",
                  title: "Error",
                  text: "Error al cambiar el estado del pedido",
                });
              });
          },
        });
      }

      // Barista: Accept individual item (PENDING -> IN_PREPARATION)
      function acceptItem(orderId, itemId, itemName) {
        Swal.fire({
          title: "¬øComenzar preparaci√≥n?",
          text: `¬øDeseas comenzar a preparar: ${itemName}?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "S√≠, comenzar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#3b82f6",
          cancelButtonColor: "#6b7280",
        }).then((result) => {
          if (result.isConfirmed) {
            changeItemStatus(
              orderId,
              itemId,
              itemName,
              "IN_PREPARATION",
              "Aceptando item...",
              "Item Aceptado",
              "Has comenzado a preparar este item"
            );
          }
        });
      }

      // Barista: Mark individual item as ready (IN_PREPARATION -> READY)
      function markItemReady(orderId, itemId, itemName) {
        Swal.fire({
          title: "¬øMarcar como listo?",
          text: `¬øEl item ${itemName} est√° listo?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "S√≠, est√° listo",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#6b7280",
        }).then((result) => {
          if (result.isConfirmed) {
            changeItemStatus(
              orderId,
              itemId,
              itemName,
              "READY",
              "Marcando item como listo...",
              "Item Listo",
              "El item est√° listo para servir"
            );
          }
        });
      }

      // Generic function to change item status (for barista)
      function changeItemStatus(
        orderId,
        itemId,
        itemName,
        newStatus,
        loadingText,
        successTitle,
        successText
      ) {
        Swal.fire({
          title: loadingText,
          text: "Por favor espere",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            Swal.showLoading();

            fetch(`/${currentRole}/orders/${orderId}/change-items-status`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `itemDetailIds=${itemId}&newStatus=${newStatus}`,
            })
              .then((response) => response.json())
              .then((data) => {
                Swal.close();

                if (data.success) {
                  Swal.fire({
                    icon: "success",
                    title: successTitle,
                    text: `${successText}: ${itemName}`,
                    timer: 1500,
                    showConfirmButton: false,
                  }).then(() => {
                    // Reload to update the view
                    window.location.reload();
                  });
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text:
                      data.message || "No se pudo cambiar el estado del item",
                  });
                }
              })
              .catch((error) => {
                Swal.close();
                console.error("Error:", error);
                Swal.fire({
                  icon: "error",
                  title: "Error",
                  text: "Error al cambiar el estado del item",
                });
              });
          },
        });
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // CHEF: Order-level buttons that change ALL chef items
        document
          .querySelectorAll(".btn-accept-all-chef-items")
          .forEach((button) => {
            button.addEventListener("click", function () {
              const orderId = this.getAttribute("data-order-id");
              const orderNumber = this.getAttribute("data-order-number");
              acceptAllChefItems(orderId, orderNumber);
            });
          });

        document.querySelectorAll(".btn-mark-all-ready").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const orderNumber = this.getAttribute("data-order-number");
            markAllChefItemsReady(orderId, orderNumber);
          });
        });

        // Accept item buttons - Chef and Barista (individual control)
        document.querySelectorAll(".btn-accept-item").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const itemId = this.getAttribute("data-item-id");
            const itemName = this.getAttribute("data-item-name");
            acceptItem(orderId, itemId, itemName);
          });
        });

        // Mark item ready buttons - Chef and Barista (individual control)
        document.querySelectorAll(".btn-ready-item").forEach((button) => {
          button.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            const itemId = this.getAttribute("data-item-id");
            const itemName = this.getAttribute("data-item-name");
            markItemReady(orderId, itemId, itemName);
          });
        });
      });
    </script>

    <!-- WebSocket Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let reconnectAttempts = 0;
      const MAX_RECONNECT_ATTEMPTS = 5;
      const RECONNECT_DELAY = 3000;

      function connectWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        // Disable debug logging
        stompClient.debug = null;

        stompClient.connect(
          {},
          function (frame) {
            console.log("‚úÖ WebSocket Connected");
            reconnectAttempts = 0;
            updateConnectionStatus(true);

            // Subscribe to role-specific orders channel
            // Chef subscribes to /topic/chef/orders
            // Barista subscribes to /topic/barista/orders
            const ordersTopic = `/topic/${currentRole}/orders`;
            console.log(`üîå Subscribing to: ${ordersTopic}`);

            stompClient.subscribe(ordersTopic, function (message) {
              console.log(
                `üîå [PENDING] Raw WebSocket message received on ${ordersTopic}:`,
                message.body
              );
              const notification = JSON.parse(message.body);
              console.log("üîå [PENDING] Parsed notification:", notification);
              handleOrderNotification(notification);
            });

            // Subscribe to personal queue for assigned orders
            stompClient.subscribe("/user/queue/orders", function (message) {
              console.log(
                "üîå [PENDING] Personal notification received:",
                message.body
              );
              const notification = JSON.parse(message.body);
              console.log(
                "üîå [PENDING] Parsed personal notification:",
                notification
              );
              handleOrderNotification(notification);
            });

            // Subscribe to kitchen stats
            stompClient.subscribe("/topic/kitchen/stats", function (message) {
              const stats = JSON.parse(message.body);
              updateKitchenStats(stats);
            });
          },
          function (error) {
            console.error("WebSocket Error: ", error);
            updateConnectionStatus(false);
            attemptReconnect();
          }
        );

        socket.onclose = function () {
          console.log("WebSocket Disconnected");
          updateConnectionStatus(false);
          attemptReconnect();
        };
      }

      function attemptReconnect() {
        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          reconnectAttempts++;
          console.log(
            `Reconnecting... Attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`
          );
          setTimeout(connectWebSocket, RECONNECT_DELAY);
        } else {
          console.error("Max reconnection attempts reached");
          showNotification(
            "Conexi√≥n perdida",
            "No se pudo reconectar al servidor. Por favor recarga la p√°gina.",
            "error"
          );
        }
      }

      function updateConnectionStatus(connected) {
        // Add a connection status indicator if needed
        const statusIndicator = document.getElementById("ws-status");
        if (statusIndicator) {
          statusIndicator.className = connected ? "connected" : "disconnected";
          statusIndicator.title = connected ? "Conectado" : "Desconectado";
        }
      }

      function handleOrderNotification(notification) {
        console.log("üì¨ [PENDING] Notification received:", notification);
        console.log(
          "üì¨ [PENDING] Notification type:",
          notification.notificationType
        );
        console.log("üì¨ [PENDING] Order number:", notification.orderNumber);

        let title = "Actualizaci√≥n";
        let icon = "info";
        let message = notification.message || "Cambio en pedido";

        // Determine notification type and customize display
        if (notification.notificationType === "NEW_ORDER") {
          console.log("üÜï [PENDING] Processing NEW_ORDER");
          title = "üîî Nuevo Pedido";
          message = `Pedido #${notification.orderNumber} - ${notification.orderType} - ${notification.itemCount} items - Total: $${notification.total}`;
          icon = "info";

          // ALWAYS play sound for new orders
          console.log("üîä Chef Pending - Playing sound for new order");
          playNotificationSound();

          // Request browser notification
          requestBrowserNotification(
            "Nuevo Pedido",
            `Pedido #${notification.orderNumber} - ${notification.itemCount} items`
          );
        } else if (notification.notificationType === "ORDER_ACCEPTED") {
          console.log("‚úÖ [PENDING] Processing ORDER_ACCEPTED");
          // Another chef/barista accepted this order - hide it from current view
          const currentUser = /*[[${currentChef}]]*/ "";
          const acceptedBy = notification.chefName;

          // If it wasn't me who accepted it, hide the order
          if (acceptedBy !== currentUser) {
            console.log(
              `üö´ Order ${notification.orderNumber} accepted by ${acceptedBy}, hiding from view`
            );
            const orderCard = document.querySelector(
              `[data-order-id="${notification.orderId}"]`
            );
            if (orderCard) {
              orderCard.style.opacity = "0";
              orderCard.style.transition = "opacity 0.5s ease-out";
              setTimeout(() => {
                orderCard.remove();
                // Update empty state if no orders left
                const ordersGrid = document.getElementById("ordersGrid");
                if (ordersGrid && ordersGrid.children.length === 0) {
                  location.reload();
                }
              }, 500);
            }

            title = "‚ÑπÔ∏è Orden Asignada";
            message = `Pedido #${notification.orderNumber} fue aceptado por ${acceptedBy}`;
            icon = "info";
          } else {
            // I accepted it, no need to do anything (it's already in my view)
            return;
          }
        } else if (notification.notificationType === "ORDER_CANCELLED") {
          console.log("‚ö†Ô∏è [PENDING] Processing ORDER_CANCELLED");
          title = "‚ö†Ô∏è Pedido Cancelado";
          message =
            notification.message ||
            `El pedido #${notification.orderNumber} ha sido cancelado`;
          icon = "warning";
          playNotificationSound();

          // Reload page immediately to remove cancelled order from view
          showNotification(title, message, icon);
          setTimeout(() => {
            console.log(
              "üîÑ [PENDING] Reloading page due to order cancellation"
            );
            window.location.reload();
          }, 1500);
          return; // Exit early to prevent duplicate reload
        } else if (notification.notificationType === "ITEMS_ADDED") {
          console.log("‚ûï [PENDING] Processing ITEMS_ADDED");
          console.log("‚ûï [PENDING] Will play sound and reload page");

          title = "‚ûï Items Agregados";
          message = `Pedido #${notification.orderNumber} - Se agregaron nuevos items a la orden`;
          icon = "info";

          // Play sound when items are added to existing order
          console.log("üîä Chef Pending - Playing sound for items added");
          playNotificationSound();
        } else if (notification.notificationType === "STATUS_CHANGE") {
          title =
            "üìä " +
            (notification.status === "CANCELLED"
              ? "Pedido Cancelado"
              : "Estado Actualizado");
          message = `Pedido #${notification.orderNumber} - ${notification.message}`;
          icon = notification.status === "CANCELLED" ? "warning" : "success";

          // NO sound for regular status changes
        }

        // Show notification
        showNotification(title, message, icon);

        // Reload for NEW_ORDER and ITEMS_ADDED
        // This ensures orders with new items appear in pending view
        if (
          notification.notificationType === "NEW_ORDER" ||
          notification.notificationType === "ITEMS_ADDED"
        ) {
          console.log(
            "üîÑ [PENDING] Will reload page in 1.5 seconds for:",
            notification.notificationType
          );
          setTimeout(() => {
            console.log("üîÑ [PENDING] RELOADING NOW!");
            window.location.reload();
          }, 1500);
        } else {
          console.log(
            "‚è≠Ô∏è [PENDING] No reload - notification type:",
            notification.notificationType
          );
        }
      }

      function handleNewOrderNotification(notification) {
        // Legacy function - now handled by handleOrderNotification
        handleOrderNotification(notification);
      }

      function handleStatusChangeNotification(notification) {
        console.log("Order Status Changed:", notification);

        // Show notification for status changes and item additions
        if (notification.message) {
          showNotification("üìä Actualizaci√≥n", notification.message, "info");
          // NO sound for status changes - only for NEW_ORDER and ITEMS_ADDED
        }

        // NO automatic reload - changeOrderStatus() already handles page reload
        // This prevents infinite reload loop when accepting orders
      }

      function updateKitchenStats(stats) {
        console.log("Kitchen Stats Updated:", stats);
        // Update stats in UI if they exist
        const pendingCountEl = document.getElementById("pending-count");
        const inPrepCountEl = document.getElementById("inprep-count");

        if (pendingCountEl) pendingCountEl.textContent = stats.pendingCount;
        if (inPrepCountEl) inPrepCountEl.textContent = stats.inPreparationCount;
      }

      function showNotification(title, message, type) {
        Swal.fire({
          icon: type,
          title: title,
          text: message,
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 5000,
          timerProgressBar: true,
        });
      }

      function playNotificationSound() {
        try {
          const audio = new Audio("/sounds/notification.mp3");
          audio.volume = 0.5;

          // Log attempt
          console.log("üîä Attempting to play notification sound...");

          audio
            .play()
            .then(() => {
              console.log("‚úÖ Sound played successfully");
            })
            .catch((error) => {
              console.warn("‚ö†Ô∏è Sound playback prevented:", error.message);
              console.log(
                "üí° User interaction may be required to enable sound"
              );
            });

          // Handle audio errors
          audio.onerror = function (e) {
            console.error("‚ùå Audio file not found or failed to load:", e);
            console.log(
              "üìÅ Make sure notification.mp3 exists in /static/sounds/"
            );
          };
        } catch (e) {
          console.error("‚ùå Error creating audio:", e);
        }
      }

      function requestBrowserNotification(title, body) {
        if (!("Notification" in window)) {
          return;
        }

        if (Notification.permission === "granted") {
          new Notification(title, { body: body, icon: "/images/logo.png" });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              new Notification(title, { body: body, icon: "/images/logo.png" });
            }
          });
        }
      }

      // Initialize WebSocket on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Request notification permission
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission();
        }

        // Connect to WebSocket
        connectWebSocket();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        if (stompClient !== null) {
          stompClient.disconnect();
        }
      });
    </script>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>
  </body>
</html>
