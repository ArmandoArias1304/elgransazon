<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Gran Saz√≥n - Mi Perfil</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />
    <!-- Leaflet CSS for maps -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Sistema de Temas (Modo Claro/Oscuro) -->
    <div th:replace="~{fragments/theme :: themeResources}"></div>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Leaflet JS for maps -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#38e07b",
              "primary-dark": "#2bc866",
              "background-light": "#f8fafc",
              "background-dark": "#0f172a",
            },
            fontFamily: {
              display: ["Work Sans", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      #addressMap {
        height: 350px;
        width: 100%;
        border-radius: 12px;
        z-index: 1;
      }
      .leaflet-container {
        font-family: "Work Sans", sans-serif;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-background-light to-gray-50 dark:from-background-dark dark:to-gray-900 font-display text-gray-800 dark:text-gray-200"
  >
    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-4xl pb-32">
      <!-- HEADER -->
      <div class="mb-6 sm:mb-8">
        <a
          href="/client/dashboard"
          class="inline-flex items-center gap-2 text-primary hover:text-primary-dark font-semibold mb-4 transition-colors"
        >
          <span class="material-symbols-outlined">arrow_back</span>
          Volver al Dashboard
        </a>
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
        >
          <div>
            <h1
              class="text-2xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-2"
            >
              Mi Perfil
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
              Actualiza tu informaci√≥n personal
            </p>
          </div>
        </div>
      </div>

      <!-- SUCCESS MESSAGE -->
      <div
        th:if="${successMessage}"
        class="mb-6 rounded-xl bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 p-4 flex items-start gap-3"
      >
        <span
          class="material-symbols-outlined text-green-600 dark:text-green-400 text-2xl"
        >
          check_circle
        </span>
        <div>
          <p
            class="font-semibold text-green-800 dark:text-green-300"
            th:text="${successMessage}"
          >
            Perfil actualizado exitosamente
          </p>
        </div>
      </div>

      <!-- ERROR MESSAGE -->
      <div
        th:if="${errorMessage}"
        class="mb-6 rounded-xl bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-4 flex items-start gap-3"
      >
        <span
          class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl"
        >
          error
        </span>
        <div>
          <p
            class="font-semibold text-red-800 dark:text-red-300"
            th:text="${errorMessage}"
          >
            Error al actualizar perfil
          </p>
        </div>
      </div>

      <!-- PROFILE FORM -->
      <div
        class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl overflow-hidden"
      >
        <!-- Form Header -->
        <div
          class="px-6 py-4 bg-gradient-to-r from-primary to-primary-dark flex items-center gap-3"
        >
          <span class="material-symbols-outlined text-white text-3xl">
            account_circle
          </span>
          <h2 class="text-2xl font-bold text-white">Informaci√≥n Personal</h2>
        </div>

        <!-- Form Body -->
        <form
          th:action="@{/client/profile/update}"
          th:object="${profileDTO}"
          method="post"
          class="p-6 sm:p-8"
        >
          <div class="space-y-6">
            <!-- Full Name -->
            <div>
              <label
                for="fullName"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">person</span>
                  Nombre Completo
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="text"
                id="fullName"
                th:field="*{fullName}"
                class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                placeholder="Ingresa tu nombre completo"
                required
              />
              <p
                th:if="${#fields.hasErrors('fullName')}"
                th:errors="*{fullName}"
                class="mt-2 text-sm text-red-600 dark:text-red-400"
              ></p>
            </div>

            <!-- Username -->
            <div>
              <label
                for="username"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">badge</span>
                  Nombre de Usuario
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="text"
                id="username"
                th:field="*{username}"
                class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                placeholder="Ingresa tu nombre de usuario"
                pattern="^[a-zA-Z0-9_]+$"
                title="Solo letras, n√∫meros y gui√≥n bajo"
                required
              />
              <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                Solo letras, n√∫meros y gui√≥n bajo (_)
              </p>
              <p
                th:if="${#fields.hasErrors('username')}"
                th:errors="*{username}"
                class="mt-2 text-sm text-red-600 dark:text-red-400"
              ></p>
            </div>

            <!-- Email (Read-only) -->
            <div>
              <label
                for="email"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">email</span>
                  Correo Electr√≥nico
                  <span class="text-xs font-normal text-gray-500"
                    >(No editable)</span
                  >
                </span>
              </label>
              <input
                type="email"
                id="email"
                th:value="${customer.email}"
                class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-500 dark:text-gray-400 cursor-not-allowed"
                readonly
                disabled
              />
              <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                El correo electr√≥nico no se puede modificar
              </p>
            </div>

            <!-- Phone -->
            <div>
              <label
                for="phone"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">phone</span>
                  Tel√©fono
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="tel"
                id="phone"
                th:field="*{phone}"
                class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                placeholder="Ingresa tu n√∫mero de tel√©fono"
                pattern="^[+]?[0-9\-\s()]{7,20}$"
                title="Formato de tel√©fono v√°lido (7-20 caracteres)"
                required
              />
              <p
                th:if="${#fields.hasErrors('phone')}"
                th:errors="*{phone}"
                class="mt-2 text-sm text-red-600 dark:text-red-400"
              ></p>
            </div>
          </div>

          <!-- Form Actions -->
          <div
            class="flex gap-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-800"
          >
            <button
              type="submit"
              class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-xl"
            >
              <span class="material-symbols-outlined">save</span>
              Guardar Informaci√≥n
            </button>
            <a
              href="/client/dashboard"
              class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-bold transition-all"
            >
              <span class="material-symbols-outlined">cancel</span>
              Cancelar
            </a>
          </div>
        </form>
      </div>

      <!-- DELIVERY ADDRESSES SECTION (with Map) -->
      <div
        class="mt-6 rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl overflow-hidden"
      >
        <!-- Addresses Header -->
        <div
          class="px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-white text-3xl">
              location_on
            </span>
            <h2 class="text-2xl font-bold text-white">
              Mis Direcciones de Entrega
            </h2>
          </div>
          <button
            type="button"
            onclick="openAddAddressModal()"
            class="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-semibold transition-all"
          >
            <span class="material-symbols-outlined">add</span>
            Nueva Direcci√≥n
          </button>
        </div>

        <!-- Addresses Body -->
        <div class="p-6">
          <!-- Existing Addresses List -->
          <div id="addressesList" class="space-y-3 mb-6">
            <div
              th:if="${#lists.isEmpty(addresses)}"
              class="text-center py-8 text-gray-500 dark:text-gray-400"
            >
              <span class="material-symbols-outlined text-5xl mb-2 block"
                >add_location</span
              >
              <p>No tienes direcciones guardadas</p>
              <p class="text-sm">
                Agrega una direcci√≥n para pedidos a domicilio
              </p>
            </div>

            <div
              th:each="addr : ${addresses}"
              th:data-id="${addr.idAddress}"
              th:data-lat="${addr.latitude}"
              th:data-lng="${addr.longitude}"
              class="address-card flex items-start gap-4 p-4 rounded-xl border-2 transition-all cursor-pointer"
              th:classappend="${addr.isDefault} ? 'border-primary bg-primary/5' : 'border-gray-200 dark:border-gray-700 hover:border-primary/50'"
              th:onclick="|viewAddressOnMap(${addr.idAddress})|"
            >
              <div class="flex-shrink-0">
                <span
                  th:if="${addr.isDefault}"
                  class="material-symbols-outlined text-primary text-3xl"
                  >home</span
                >
                <span
                  th:unless="${addr.isDefault}"
                  class="material-symbols-outlined text-gray-400 text-3xl"
                  >location_on</span
                >
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span
                    class="font-bold text-gray-900 dark:text-white"
                    th:text="${addr.label}"
                    >Casa</span
                  >
                  <span
                    th:if="${addr.isDefault}"
                    class="text-xs px-2 py-0.5 bg-primary/20 text-primary rounded-full font-semibold"
                    >Predeterminada</span
                  >
                </div>
                <p
                  class="text-sm text-gray-600 dark:text-gray-400 truncate"
                  th:text="${addr.address}"
                >
                  Direcci√≥n completa...
                </p>
                <p
                  th:if="${addr.reference}"
                  class="text-xs text-gray-500 dark:text-gray-500 mt-1"
                >
                  <span class="material-symbols-outlined text-xs align-middle"
                    >info</span
                  >
                  <span th:text="${addr.reference}">Referencia</span>
                </p>
              </div>
              <div class="flex items-center gap-1">
                <button
                  type="button"
                  th:onclick="|event.stopPropagation(); editAddress(${addr.idAddress})|"
                  class="p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition-all"
                  title="Editar"
                >
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button
                  type="button"
                  th:onclick="|event.stopPropagation(); deleteAddress(${addr.idAddress})|"
                  class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-all"
                  title="Eliminar"
                >
                  <span class="material-symbols-outlined">delete</span>
                </button>
                <button
                  th:unless="${addr.isDefault}"
                  type="button"
                  th:onclick="|event.stopPropagation(); setDefaultAddress(${addr.idAddress})|"
                  class="p-2 text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded-lg transition-all"
                  title="Establecer como predeterminada"
                >
                  <span class="material-symbols-outlined">star</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Map Preview (shows selected address) -->
          <div id="mapPreviewContainer" class="hidden">
            <h3
              class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2"
            >
              <span class="material-symbols-outlined">map</span>
              Ubicaci√≥n en el Mapa
            </h3>
            <div
              id="addressMapPreview"
              style="height: 250px; border-radius: 12px"
            ></div>
          </div>
        </div>
      </div>

      <!-- CHANGE PASSWORD SECTION -->
      <div
        class="mt-6 rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl overflow-hidden"
      >
        <!-- Password Form Header -->
        <div
          class="px-6 py-4 bg-gradient-to-r from-orange-500 to-orange-600 flex items-center gap-3"
        >
          <span class="material-symbols-outlined text-white text-3xl">
            lock
          </span>
          <h2 class="text-2xl font-bold text-white">Cambiar Contrase√±a</h2>
        </div>

        <!-- Password Form Body -->
        <form
          th:action="@{/client/profile/change-password}"
          th:object="${passwordDTO}"
          method="post"
          class="p-6 sm:p-8"
        >
          <div class="space-y-6">
            <!-- New Password -->
            <div>
              <label
                for="newPassword"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg"
                    >lock_open</span
                  >
                  Nueva Contrase√±a
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="password"
                id="newPassword"
                th:field="*{newPassword}"
                class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                placeholder="Ingresa tu nueva contrase√±a"
                minlength="6"
                required
              />
              <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                M√≠nimo 6 caracteres
              </p>
              <p
                th:if="${#fields.hasErrors('newPassword')}"
                th:errors="*{newPassword}"
                class="mt-2 text-sm text-red-600 dark:text-red-400"
              ></p>
            </div>

            <!-- Confirm Password -->
            <div>
              <label
                for="confirmPassword"
                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2"
              >
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg"
                    >lock_reset</span
                  >
                  Confirmar Contrase√±a
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input
                type="password"
                id="confirmPassword"
                th:field="*{confirmPassword}"
                class="w-full px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                placeholder="Confirma tu nueva contrase√±a"
                minlength="6"
                required
              />
              <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                Debe coincidir con la contrase√±a anterior
              </p>
              <p
                th:if="${#fields.hasErrors('confirmPassword')}"
                th:errors="*{confirmPassword}"
                class="mt-2 text-sm text-red-600 dark:text-red-400"
              ></p>
            </div>
          </div>

          <!-- Password Form Actions -->
          <div
            class="flex gap-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-800"
          >
            <button
              type="submit"
              class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-xl"
            >
              <span class="material-symbols-outlined">password</span>
              Cambiar Contrase√±a
            </button>
          </div>
        </form>
      </div>

      <!-- APPEARANCE SECTION (Theme Toggle) -->
      <div
        class="mt-6 rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl overflow-hidden"
      >
        <!-- Theme Header -->
        <div
          class="px-6 py-4 bg-gradient-to-r from-purple-500 to-purple-600 flex items-center gap-3"
        >
          <span class="material-symbols-outlined text-white text-3xl">
            palette
          </span>
          <h2 class="text-2xl font-bold text-white">Apariencia</h2>
        </div>

        <!-- Theme Body -->
        <div class="p-6">
          <div
            class="flex items-center justify-between p-4 rounded-xl bg-gray-50 dark:bg-gray-800"
          >
            <div class="flex items-center gap-3">
              <span
                class="material-symbols-outlined text-2xl text-gray-700 dark:text-gray-300"
                id="profile-theme-icon"
              >
                light_mode
              </span>
              <div>
                <p class="font-semibold text-gray-900 dark:text-white">
                  Modo de Visualizaci√≥n
                </p>
                <p
                  class="text-sm text-gray-600 dark:text-gray-400"
                  id="profile-theme-description"
                >
                  Cambia entre modo claro y oscuro
                </p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="profile-theme-switch"
                class="sr-only peer"
              />
              <div
                class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/40 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"
              ></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Account Info -->
      <div
        class="mt-6 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4"
      >
        <div class="flex items-start gap-3">
          <span
            class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl"
          >
            info
          </span>
          <div>
            <p class="font-semibold text-blue-800 dark:text-blue-300 mb-1">
              Informaci√≥n de la Cuenta
            </p>
            <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
              <li>‚Ä¢ El nombre de usuario y tel√©fono deben ser √∫nicos</li>
              <li>‚Ä¢ El correo electr√≥nico no se puede modificar</li>
              <li>
                ‚Ä¢ La direcci√≥n es necesaria para realizar pedidos a domicilio
              </li>
              <li>‚Ä¢ Los campos marcados con * son obligatorios</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Script del Sistema de Temas -->
    <div th:replace="~{fragments/theme :: themeScript}"></div>

    <!-- Script para el switch de tema en perfil -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const themeSwitch = document.getElementById("profile-theme-switch");
        const themeIcon = document.getElementById("profile-theme-icon");
        const themeDescription = document.getElementById(
          "profile-theme-description"
        );

        // Leer tema actual de localStorage
        const currentTheme =
          localStorage.getItem("elgransazon-theme") || "light";

        // Configurar estado inicial del switch
        if (currentTheme === "dark") {
          themeSwitch.checked = true;
          themeIcon.textContent = "dark_mode";
          themeDescription.textContent = "Modo oscuro activado";
        } else {
          themeSwitch.checked = false;
          themeIcon.textContent = "light_mode";
          themeDescription.textContent = "Cambia entre modo claro y oscuro";
        }

        // Manejar cambio de tema
        themeSwitch.addEventListener("change", function () {
          if (this.checked) {
            // Activar modo oscuro
            document.documentElement.classList.add("dark");
            localStorage.setItem("elgransazon-theme", "dark");
            themeIcon.textContent = "dark_mode";
            themeDescription.textContent = "Modo oscuro activado";
          } else {
            // Activar modo claro
            document.documentElement.classList.remove("dark");
            localStorage.setItem("elgransazon-theme", "light");
            themeIcon.textContent = "light_mode";
            themeDescription.textContent = "Cambia entre modo claro y oscuro";
          }
        });
      });
    </script>

    <script th:inline="javascript">
      // Show SweetAlert on success or error
      /*<![CDATA[*/
      const successMessage = /*[[${successMessage}]]*/ null;
      const errorMessage = /*[[${errorMessage}]]*/ null;

      if (successMessage) {
        Swal.fire({
          icon: "success",
          title: "¬°√âxito!",
          text: successMessage,
          confirmButtonColor: "#38e07b",
        });
      }

      if (errorMessage) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: errorMessage,
          confirmButtonColor: "#ef4444",
        });
      }
      /*]]>*/
    </script>

    <!-- Address Map Management Script -->
    <script>
      // Map variables
      let previewMap = null;
      let previewMarker = null;
      let addressModal = null;
      let modalMap = null;
      let modalMarker = null;
      let editingAddressId = null;

      // Default center (Mexico City - adjust to your location)
      const DEFAULT_LAT = 19.4326;
      const DEFAULT_LNG = -99.1332;
      const DEFAULT_ZOOM = 13;

      // Initialize preview map
      function initPreviewMap(lat, lng) {
        const container = document.getElementById("mapPreviewContainer");
        container.classList.remove("hidden");

        if (previewMap) {
          previewMap.setView([lat, lng], 16);
          previewMarker.setLatLng([lat, lng]);
        } else {
          previewMap = L.map("addressMapPreview").setView([lat, lng], 16);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap",
          }).addTo(previewMap);
          previewMarker = L.marker([lat, lng]).addTo(previewMap);
        }
      }

      // View address on map
      function viewAddressOnMap(addressId) {
        const card = document.querySelector(`[data-id="${addressId}"]`);
        if (card) {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          if (lat && lng && lat !== 0 && lng !== 0) {
            initPreviewMap(lat, lng);
          }
        }
      }

      // Open add address modal
      function openAddAddressModal() {
        editingAddressId = null;
        showAddressModal("Nueva Direcci√≥n", {
          label: "",
          address: "",
          reference: "",
          latitude: DEFAULT_LAT,
          longitude: DEFAULT_LNG,
          isDefault: false,
        });
      }

      // Edit address
      async function editAddress(addressId) {
        try {
          const response = await fetch("/client/addresses");
          const addresses = await response.json();
          const address = addresses.find((a) => a.id === addressId);

          if (address) {
            editingAddressId = addressId;
            showAddressModal("Editar Direcci√≥n", {
              label: address.label,
              address: address.address,
              reference: address.reference || "",
              latitude: address.latitude,
              longitude: address.longitude,
              isDefault: address.isDefault,
            });
          }
        } catch (error) {
          console.error("Error loading address:", error);
          Swal.fire("Error", "No se pudo cargar la direcci√≥n", "error");
        }
      }

      // Show address modal with map
      function showAddressModal(title, data) {
        const isEdit = editingAddressId !== null;
        const lat = data.latitude || DEFAULT_LAT;
        const lng = data.longitude || DEFAULT_LNG;

        Swal.fire({
          title: title,
          html: `
            <div class="text-left space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Nombre de la direcci√≥n *</label>
                <input type="text" id="swal-label" class="swal2-input" placeholder="Ej: Casa, Trabajo, Oficina" value="${
                  data.label
                }" style="margin: 0; width: 100%;">
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Direcci√≥n completa *</label>
                <div style="display: flex; gap: 8px; margin: 0;">
                  <textarea id="swal-address" class="swal2-textarea" placeholder="Calle, n√∫mero, colonia, ciudad..." style="margin: 0; flex: 1; height: 60px;">${
                    data.address
                  }</textarea>
                  <button type="button" onclick="searchAddressOnMap()" 
                          style="padding: 8px 16px; background: #38e07b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; height: 60px; display: flex; align-items: center; gap: 4px;"
                          onmouseover="this.style.background='#2bc866'" 
                          onmouseout="this.style.background='#38e07b'">
                    <span class="material-symbols-outlined" style="font-size: 18px;">search</span>
                    Buscar
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Referencia (opcional)</label>
                <input type="text" id="swal-reference" class="swal2-input" placeholder="Ej: Port√≥n azul, frente al parque" value="${
                  data.reference
                }" style="margin: 0; width: 100%;">
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">üìç Marca tu ubicaci√≥n en el mapa *</label>
                <div style="position: relative; margin-bottom: 8px;">
                  <input type="text" id="map-search" 
                         style="margin: 0; width: 100%; padding: 10px 12px; border: 2px solid #38e07b; border-radius: 8px; font-size: 14px; background: #f0fdf4;" 
                         placeholder="üîç Busca tu colonia o zona para navegar al √°rea..."
                         oninput="searchPlacesLive(this.value)"
                         autocomplete="off">
                  <div id="search-suggestions" 
                       style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
                <p class="text-xs text-green-600 font-semibold mb-2">üëÜ Busca tu zona, luego haz CLIC en el mapa para marcar tu ubicaci√≥n exacta</p>
                <div id="swalMap" style="height: 300px; border-radius: 8px; border: 2px solid #e5e7eb;"></div>
                <input type="hidden" id="swal-lat" value="${lat}">
                <input type="hidden" id="swal-lng" value="${lng}">
              </div>
              <div class="flex items-center gap-2 pt-2">
                <input type="checkbox" id="swal-default" ${
                  data.isDefault ? "checked" : ""
                } class="w-4 h-4 text-primary rounded">
                <label for="swal-default" class="text-sm text-gray-600">Establecer como direcci√≥n predeterminada</label>
              </div>
              <div id="locationButtons" class="flex gap-2">
                <button type="button" onclick="useCurrentLocation()" class="flex-1 px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-semibold flex items-center justify-center gap-1">
                  <span class="material-symbols-outlined text-lg">my_location</span>
                  Usar mi ubicaci√≥n actual
                </button>
              </div>
            </div>
          `,
          width: 600,
          showCancelButton: true,
          confirmButtonText: isEdit ? "Guardar Cambios" : "Guardar Direcci√≥n",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#38e07b",
          cancelButtonColor: "#6b7280",
          allowOutsideClick: false,
          allowEscapeKey: true,
          didOpen: () => {
            // Initialize modal map
            setTimeout(() => {
              modalMap = L.map("swalMap").setView(
                [lat, lng],
                lat === DEFAULT_LAT ? DEFAULT_ZOOM : 16
              );
              L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
                  attribution: "¬© OpenStreetMap",
                }
              ).addTo(modalMap);

              modalMarker = L.marker([lat, lng], { draggable: true }).addTo(
                modalMap
              );

              // Update coordinates when marker is dragged
              modalMarker.on("dragend", function (e) {
                const pos = e.target.getLatLng();
                document.getElementById("swal-lat").value = pos.lat;
                document.getElementById("swal-lng").value = pos.lng;
                reverseGeocode(pos.lat, pos.lng);
              });

              // Click on map to move marker
              modalMap.on("click", function (e) {
                modalMarker.setLatLng(e.latlng);
                document.getElementById("swal-lat").value = e.latlng.lat;
                document.getElementById("swal-lng").value = e.latlng.lng;
                reverseGeocode(e.latlng.lat, e.latlng.lng);
              });
            }, 100);
          },
          preConfirm: () => {
            const label = document.getElementById("swal-label").value.trim();
            const address = document
              .getElementById("swal-address")
              .value.trim();
            const reference = document
              .getElementById("swal-reference")
              .value.trim();
            const latitude = parseFloat(
              document.getElementById("swal-lat").value
            );
            const longitude = parseFloat(
              document.getElementById("swal-lng").value
            );
            const setAsDefault =
              document.getElementById("swal-default").checked;

            if (!label) {
              Swal.showValidationMessage("Ingresa un nombre para la direcci√≥n");
              return false;
            }
            if (!address) {
              Swal.showValidationMessage("Ingresa la direcci√≥n completa");
              return false;
            }
            if (
              !latitude ||
              !longitude ||
              (latitude === DEFAULT_LAT && longitude === DEFAULT_LNG)
            ) {
              Swal.showValidationMessage(
                "Por favor marca tu ubicaci√≥n en el mapa"
              );
              return false;
            }

            return {
              label,
              address,
              reference,
              latitude,
              longitude,
              setAsDefault,
            };
          },
        }).then(async (result) => {
          if (result.isConfirmed && result.value) {
            await saveAddress(result.value);
          }
        });
      }

      // Use current location
      function useCurrentLocation() {
        if (!navigator.geolocation) {
          Swal.showValidationMessage("Tu navegador no soporta geolocalizaci√≥n");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            if (modalMap && modalMarker) {
              modalMap.setView([lat, lng], 17);
              modalMarker.setLatLng([lat, lng]);
              document.getElementById("swal-lat").value = lat;
              document.getElementById("swal-lng").value = lng;
              reverseGeocode(lat, lng);
            }
          },
          (error) => {
            console.error("Geolocation error:", error);
            Swal.fire({
              icon: "warning",
              title: "No se pudo obtener tu ubicaci√≥n",
              text: "Aseg√∫rate de permitir el acceso a tu ubicaci√≥n",
              confirmButtonColor: "#38e07b",
            });
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      // Reverse geocode (get address from coordinates) - SIEMPRE llena el campo
      async function reverseGeocode(lat, lng) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
          );
          const data = await response.json();

          if (data.display_name) {
            const addressInput = document.getElementById("swal-address");
            if (addressInput) {
              addressInput.value = data.display_name;
              // Cambiar el borde del textarea para indicar que se llen√≥
              addressInput.style.borderColor = "#38e07b";
              addressInput.style.backgroundColor = "#f0fdf4";
            }
          }
        } catch (error) {
          console.error("Reverse geocode error:", error);
        }
      }

      // Forward geocode (search address and move map)
      async function searchAddressOnMap() {
        const addressInput = document.getElementById("swal-address");
        const query = addressInput.value.trim();

        if (!query) {
          Swal.showValidationMessage(
            "Por favor escribe una direcci√≥n para buscar"
          );
          return;
        }

        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query
            )}&limit=1`
          );
          const results = await response.json();

          if (results.length > 0) {
            const location = results[0];
            const lat = parseFloat(location.lat);
            const lng = parseFloat(location.lon);

            // Update map
            if (modalMap && modalMarker) {
              modalMap.setView([lat, lng], 16);
              modalMarker.setLatLng([lat, lng]);
              document.getElementById("swal-lat").value = lat;
              document.getElementById("swal-lng").value = lng;

              // Update address with full name from Nominatim
              addressInput.value = location.display_name;
            }

            // Show success toast
            const Toast = Swal.mixin({
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true,
            });
            Toast.fire({
              icon: "success",
              title: "Ubicaci√≥n encontrada",
            });
          } else {
            Swal.showValidationMessage(
              "No se encontr√≥ la direcci√≥n. Intenta con m√°s detalles (calle, colonia, ciudad)"
            );
          }
        } catch (error) {
          console.error("Geocode error:", error);
          Swal.showValidationMessage("Error al buscar la direcci√≥n");
        }
      }

      // Live search with suggestions (debounced)
      let searchTimeout = null;
      let currentSuggestions = [];

      async function searchPlacesLive(query) {
        const suggestionsDiv = document.getElementById("search-suggestions");

        // Clear previous timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // Hide suggestions if query is too short
        if (query.trim().length < 3) {
          suggestionsDiv.style.display = "none";
          return;
        }

        // Debounce: wait 500ms after user stops typing
        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                query
              )}&limit=5&addressdetails=1`
            );
            const results = await response.json();

            if (results.length > 0) {
              currentSuggestions = results;
              displaySuggestions(results);
            } else {
              suggestionsDiv.innerHTML =
                '<div style="padding: 8px; color: #6b7280; font-size: 13px;">No se encontraron resultados</div>';
              suggestionsDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Search error:", error);
          }
        }, 500);
      }

      function displaySuggestions(results) {
        const suggestionsDiv = document.getElementById("search-suggestions");

        suggestionsDiv.innerHTML = results
          .map(
            (result, index) => `
          <div onclick="event.stopPropagation(); selectSuggestion(${index})" 
               style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 13px; transition: background 0.2s;"
               onmouseover="this.style.background='#f9fafb'" 
               onmouseout="this.style.background='white'">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">
              ${result.display_name.split(",")[0]}
            </div>
            <div style="color: #6b7280; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
              ${result.display_name}
            </div>
          </div>
        `
          )
          .join("");

        suggestionsDiv.style.display = "block";
      }

      function selectSuggestion(index) {
        const location = currentSuggestions[index];
        const lat = parseFloat(location.lat);
        const lng = parseFloat(location.lon);

        // Solo mover el mapa al √°rea (NO llenar el campo de direcci√≥n)
        if (modalMap) {
          modalMap.setView([lat, lng], 16);
          // NO mover el marcador - el usuario lo har√° haciendo clic
        }

        // Limpiar b√∫squeda y ocultar sugerencias
        const searchInput = document.getElementById("map-search");
        const suggestionsDiv = document.getElementById("search-suggestions");
        if (searchInput) searchInput.value = "";
        if (suggestionsDiv) suggestionsDiv.style.display = "none";
      }

      // Close suggestions when clicking outside
      document.addEventListener("click", function (e) {
        const searchInput = document.getElementById("map-search");
        const suggestionsDiv = document.getElementById("search-suggestions");

        if (
          searchInput &&
          suggestionsDiv &&
          e.target !== searchInput &&
          !suggestionsDiv.contains(e.target)
        ) {
          suggestionsDiv.style.display = "none";
        }
      });

      // Save address
      async function saveAddress(data) {
        try {
          const isEdit = editingAddressId !== null;
          const url = isEdit
            ? `/client/addresses/${editingAddressId}`
            : "/client/addresses";
          const method = isEdit ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "¬°√âxito!",
              text: result.message,
              confirmButtonColor: "#38e07b",
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire("Error", result.message, "error");
          }
        } catch (error) {
          console.error("Save address error:", error);
          Swal.fire("Error", "No se pudo guardar la direcci√≥n", "error");
        }
      }

      // Delete address
      function deleteAddress(addressId) {
        Swal.fire({
          title: "¬øEliminar direcci√≥n?",
          text: "Esta acci√≥n no se puede deshacer",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "S√≠, eliminar",
          cancelButtonText: "Cancelar",
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const response = await fetch(`/client/addresses/${addressId}`, {
                method: "DELETE",
              });
              const data = await response.json();

              if (data.success) {
                Swal.fire({
                  icon: "success",
                  title: "Eliminada",
                  text: data.message,
                  confirmButtonColor: "#38e07b",
                }).then(() => {
                  window.location.reload();
                });
              } else {
                Swal.fire("Error", data.message, "error");
              }
            } catch (error) {
              console.error("Delete error:", error);
              Swal.fire("Error", "No se pudo eliminar la direcci√≥n", "error");
            }
          }
        });
      }

      // Set default address
      async function setDefaultAddress(addressId) {
        try {
          const response = await fetch(
            `/client/addresses/${addressId}/set-default`,
            {
              method: "POST",
            }
          );
          const data = await response.json();

          if (data.success) {
            const Toast = Swal.mixin({
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true,
            });
            Toast.fire({
              icon: "success",
              title: "Direcci√≥n predeterminada actualizada",
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire("Error", data.message, "error");
          }
        } catch (error) {
          console.error("Set default error:", error);
          Swal.fire(
            "Error",
            "No se pudo establecer como predeterminada",
            "error"
          );
        }
      }

      // Initialize - show default address on map if exists
      document.addEventListener("DOMContentLoaded", function () {
        const defaultCard = document.querySelector(
          ".address-card.border-primary"
        );
        if (defaultCard) {
          const lat = parseFloat(defaultCard.dataset.lat);
          const lng = parseFloat(defaultCard.dataset.lng);
          if (lat && lng && lat !== 0 && lng !== 0) {
            initPreviewMap(lat, lng);
          }
        }
      });
    </script>
  </body>
</html>
